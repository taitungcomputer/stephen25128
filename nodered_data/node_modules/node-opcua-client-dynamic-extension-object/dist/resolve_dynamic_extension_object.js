"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolveOpaqueStructureInExtensionObject = resolveOpaqueStructureInExtensionObject;
exports.resolveDynamicExtensionObject = resolveDynamicExtensionObject;
const node_opcua_binary_stream_1 = require("node-opcua-binary-stream");
const node_opcua_extension_object_1 = require("node-opcua-extension-object");
const node_opcua_variant_1 = require("node-opcua-variant");
const node_opcua_debug_1 = require("node-opcua-debug");
const warningLog = (0, node_opcua_debug_1.make_warningLog)(__filename);
async function resolveOpaqueStructureInExtensionObject(session, dataTypeManager, object, visited) {
    visited = visited || new Set();
    if (visited.has(object)) {
        return;
    }
    visited.add(object);
    async function fixOpaqueStructureOnElement(element, field, data, args) {
        if (!element) {
            return element;
        }
        if (element instanceof node_opcua_variant_1.Variant || element.constructor?.name === "Variant") {
            await resolveDynamicExtensionObject(session, element, dataTypeManager, data.visited);
            return element;
        }
        if (element instanceof node_opcua_extension_object_1.ExtensionObject || element?.constructor?.schema?.name === "ExtensionObject") {
            if (element instanceof node_opcua_extension_object_1.OpaqueStructure) {
                const variant = new node_opcua_variant_1.Variant({ dataType: node_opcua_variant_1.DataType.ExtensionObject, value: element });
                await resolveDynamicExtensionObject(session, variant, dataTypeManager, data.visited);
                return variant.value;
            }
            else {
                await resolveOpaqueStructureInExtensionObject(session, dataTypeManager, element, data.visited);
                return element;
            }
        }
        return element;
    }
    function fixOpaqueStructure(object, field, data, args) {
        const a = object[field.name];
        if (!a) {
            return;
        }
        if (field.isArray) {
            for (let i = 0; i < a.length; i++) {
                const x = a[i];
                data.promises.push((async () => {
                    a[i] = await fixOpaqueStructureOnElement(x, field, data, args);
                })());
            }
        }
        else {
            data.promises.push((async () => {
                object[field.name] = await fixOpaqueStructureOnElement(a, field, data, args);
            })());
        }
    }
    const promises = [];
    object.applyOnAllFields(fixOpaqueStructure, { dataTypeManager, promises, visited });
    await Promise.all(promises);
}
async function resolveDynamicExtensionObject(session, variant, dataTypeManager, visited) {
    visited = visited || new Set();
    const handleValue = async (value) => {
        if (!value) {
            return value;
        }
        if (value instanceof node_opcua_extension_object_1.OpaqueStructure) {
            try {
                const Constructor = await dataTypeManager.getExtensionObjectConstructorFromBinaryEncodingAsync(value.nodeId);
                const object = new Constructor();
                const stream = new node_opcua_binary_stream_1.BinaryStream(value.buffer);
                try {
                    object.decode(stream);
                    await resolveOpaqueStructureInExtensionObject(session, dataTypeManager, object, visited);
                    return object;
                }
                catch (err) {
                    warningLog("resolveDynamicExtensionObjectV: error decoding or resolving inner structures");
                    warningLog("Constructor = ", Constructor.name);
                    warningLog("opaqueStructure = ", value?.nodeId?.toString());
                    warningLog("resolveDynamicExtensionObjectV err = ", err.message, err.stack);
                    return value;
                }
            }
            catch (err) {
                warningLog("resolveDynamicExtensionObjectV: error getting constructor");
                warningLog("opaqueStructure = ", value.nodeId.toString());
                warningLog("err", err.message, err.stack);
                return value;
            }
        }
        if (value instanceof node_opcua_extension_object_1.ExtensionObject) {
            await resolveOpaqueStructureInExtensionObject(session, dataTypeManager, value, visited);
            return value;
        }
        if (value instanceof node_opcua_variant_1.Variant) {
            await resolveDynamicExtensionObject(session, value, dataTypeManager, visited);
            return value;
        }
        return value;
    };
    if (variant.arrayType !== node_opcua_variant_1.VariantArrayType.Scalar) {
        if (Array.isArray(variant.value)) {
            for (let i = 0; i < variant.value.length; i++) {
                variant.value[i] = await handleValue(variant.value[i]);
            }
        }
    }
    else {
        variant.value = await handleValue(variant.value);
    }
}
//# sourceMappingURL=resolve_dynamic_extension_object.js.map