import os
from django.shortcuts import render

def hello(request):
    return render(request, {"k":"ok"})


def chineseBible(request):
    BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    # ğŸ”¹ æ¨¡æ¿çµ•å°è·¯å¾‘
    template_path = os.path.join(BASE_DIR,"templates","lightup","chinesebible.html")

    # ğŸ”¹ ä¸­æ–‡è–ç¶“æª”æ¡ˆçµ•å°è·¯å¾‘
    #file_path = "/myproject/web/lightup/source/ChineseBible.txt"
     

    #BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    file_path = os.path.join(BASE_DIR, "source", "ChineseBible.txt")
    
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            text = f.read()
    except FileNotFoundError:
        return render(request, template_path, {
            "error": f"æª”æ¡ˆä¸å­˜åœ¨ï¼š{file_path}"
        })

    # ğŸ”¹ å–å¾—é—œéµå­—èˆ‡å‰å¾Œå­—å…ƒæ•¸
    keyword = request.GET.get("kword", "è€¶ç©Œ").strip()
    k = int(request.GET.get("klength", "20").strip())

    # ğŸ”¹ æœå°‹æ‰€æœ‰å‡ºç¾ä½ç½®
    results = []
    start_pos = 0
    while True:
        pos = text.find(keyword, start_pos)
        if pos == -1:
            break
        start = max(0, pos - k)
        end = min(len(text), pos + len(keyword) + k)
        snippet = text[start:end]
        results.append(snippet)
        start_pos = pos + len(keyword)

    # ğŸ”¹ å­˜å…¥ session
    request.session["rslist"] = [(i+1, s) for i, s in enumerate(results)]

    # ğŸ”¹ å‚³çµ¦æ¨¡æ¿
    return render(request, template_path, {
        "keyword": keyword,
        "k": k,
        "results": results,
        "count": len(results),
    })
